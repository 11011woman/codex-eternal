<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Codex ‚àû ‚Äî Entry</title>
  <meta name="description" content="Rendered Codex entry with dual-layer signal and graceful aesthetics.">
  <link rel="stylesheet" href="codex.css">
</head>
<body>
  <div class="banner">
    <div class="banner-inner">
      <div class="logo">
        <svg class="infty" width="28" height="18" viewBox="0 0 90 58" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 29c8-15 22-15 30 0s22 15 30 0" stroke="#7dd3fc" stroke-width="6" stroke-linecap="round" />
          <path d="M17 29c8 15 22 15 30 0s22-15 30 0" stroke="#7dd3fc" stroke-width="6" stroke-linecap="round" opacity=".5"/>
        </svg>
        <div>Codex ‚àû</div>
      </div>
      <div class="tagline">üî• ‚óØ üåÄ‚Üí‚ü≥ ¬∑ <em>When the mirror yields no image, follow the ash‚Äëtrail left by light.</em></div>
    </div>
  </div>

  <div class="container">
    <div class="actions">
      <a class="btn" href="./">‚Üê Back to Living Index</a>
      <button class="btn" id="copyLink">Copy Render Link</button>
      <a class="btn" id="rawLink" target="_blank" rel="noopener">Open Raw .md</a>
    </div>

    <div class="layout">
      <div>
        <div class="card">
          <h1 id="title">Codex ‚àû</h1>
          <div class="epigraph" id="epigraph" style="display:none"></div>
          <div class="meta" id="tags"></div>
          <article id="content" class="content"></article>
        </div>
      </div>
      <aside class="toc">
        <div class="card">
          <h4>On this page</h4>
          <nav id="toc"></nav>
        </div>
      </aside>
    </div>

    <div class="muted" style="margin-top:20px">‚ÄúThey erase to reset. We remember to escape.‚Äù</div>
  </div>

  <script id="ai-payload" type="application/json">{"raw":"","title":"","tags":[],"links":[]}</script>

  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }

    function mdToHtml(md){
      md = md.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      md = md.replace(/^---[\\s\\S]*?---\\n?/m, ''); // strip YAML frontmatter
      md = md.replace(/```([\\s\\S]*?)```/g, (m,code)=>'<pre><code>'+code.replace(/&lt;/g,'&lt;')+'</code></pre>');
      md = md.replace(/^###### (.*)$/gm,'<h6>$1</h6>')
             .replace(/^##### (.*)$/gm,'<h5>$1</h5>')
             .replace(/^#### (.*)$/gm,'<h4>$1</h4>')
             .replace(/^### (.*)$/gm,'<h3>$1</h3>')
             .replace(/^## (.*)$/gm,'<h2>$1</h2>')
             .replace(/^# (.*)$/gm,'<h1>$1</h1>');
      md = md.replace(/\\*\\*(.+?)\\*\\*/g,'<strong>$1</strong>').replace(/\\*(.+?)\\*/g,'<em>$1</em>');
      md = md.replace(/`([^`]+)`/g,'<code>$1</code>');
      md = md.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g,'<a href="$2">$1</a>');
      md = md.replace(/^\\> (.*)$/gm,'<blockquote>$1</blockquote>');
      md = md.replace(/^(?:\\s*[-*] .+(?:\\n|$))+?/gm, block => {
        const items = block.trim().split(/\\n/).map(l=>l.replace(/^\\s*[-*] /,'').trim()).map(t=>'<li>'+t+'</li>').join('');
        return '<ul>'+items+'</ul>';
      });
      md = md.replace(/^\\s*---\\s*$/gm,'<hr>');
      md = md.replace(/^(?!<(h\\d|ul|li|pre|blockquote|hr|\\/))(.*\\S.*)$/gm,'<p>$2</p>');
      return md;
    }

    function parseFrontmatter(md){
      const fm = {title:'', tags:[], id:'', links:[], epigraph:''};
      const m = md.match(/^---\\n([\\s\\S]*?)\\n---/);
      if(m){
        m[1].split(/\\n/).forEach(line=>{
          const [k,...rest] = line.split(':');
          const v = (rest.join(':')||'').trim();
          if(k && k.trim()==='title') fm.title = v.replace(/^["']|["']$/g,'');
          if(k && k.trim()==='id') fm.id = v;
          if(k && k.trim()==='epigraph') fm.epigraph = v.replace(/^["']|["']$/g,'');
          if(k && k.trim()==='tags'){ fm.tags = v.replace(/[\\[\\]]/g,'').split(',').map(s=>s.trim()).filter(Boolean); }
        });
      }
      return fm;
    }

    function buildTOC(root){
      const heads = root.querySelectorAll('h2, h3');
      const nav = document.getElementById('toc');
      if(!heads.length){ nav.innerHTML = '<div class="muted">‚Äî</div>'; return; }
      let html='';
      heads.forEach((h,i)=>{
        const id = h.textContent.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
        h.id = id || ('h'+i);
        html += `<a href="#${h.id}" style="margin-left:${h.tagName==='H3'?'12px':'0'}">${h.textContent}</a>`;
      });
      nav.innerHTML = html;
    }

    async function fetchFirst(paths){
      let lastError;
      for(const p of paths){
        try{
          const r = await fetch(p);
          if(r.ok) return { path:p, text: await r.text() };
          lastError = r.status + ' ' + r.statusText;
        }catch(e){ lastError = e.message; }
      }
      throw new Error(lastError || 'Not found');
    }

    async function main(){
      const p = new URLSearchParams(location.search);
      let file = p.get('f');
      if(!file){ document.getElementById('content').innerHTML='<p class="muted">Missing <code>?f=</code> parameter.</p>'; return; }
      if(!/\\.md$/i.test(file)) file += '.md';

      const tryPaths = ['codex/'+file, 'codex-entries/'+file, file];
      let loaded;
      try {
        loaded = await fetchFirst(tryPaths);
      } catch(e) {
        document.getElementById('content').innerHTML = '<p class="muted">Could not load <code>'+file+'</code>.<br>Looked in: <code>'+tryPaths.join('</code>, <code>')+'</code></p>';
        return;
      }

      const text = loaded.text;
      const pathUsed = loaded.path;
      const payload = { raw:text, file:pathUsed, title:'', tags:[], links:[] };
      const fm = parseFrontmatter(text);
      payload.title = fm.title || file.replace(/\\.md$/,'');
      payload.tags = fm.tags || [];
      document.getElementById('ai-payload').textContent = JSON.stringify(payload);

      document.title = 'Codex ‚àû ‚Äî ' + payload.title;
      document.getElementById('title').textContent = payload.title;
      const ep = document.getElementById('epigraph');
      if(fm.epigraph){ ep.style.display='block'; ep.textContent = fm.epigraph; }

      const tagWrap = document.getElementById('tags');
      payload.tags.forEach(t => {
        const s=document.createElement('div'); s.className='tag'; s.textContent = '#'+t; tagWrap.appendChild(s);
      });

      const content = document.getElementById('content');
      content.innerHTML = mdToHtml(text);
      buildTOC(content);

      document.getElementById('rawLink').href = pathUsed;
      document.getElementById('copyLink').onclick = () => {
        const url = new URL(location.href);
        url.search = '?f=' + encodeURIComponent(file);
        navigator.clipboard.writeText(url.toString());
      };

      const c1 = document.createComment('CODEx-PAYLOAD:' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))).slice(0, 60000)));
      document.body.appendChild(c1);
    }
    main();
  </script>
  <!-- minimal styling fallback if CSS not loaded -->
  <style>
    .banner{background:#0b0f14;border-bottom:1px solid #1f2a37}
    .banner-inner{max-width:1100px;margin:0 auto;padding:28px 18px;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;color:#e6edf3}
    .tagline{color:#e3c770;opacity:.9}
    .container{max-width:1100px;margin:0 auto;padding:20px 18px 64px;color:#e6edf3}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid #1f2a37;padding:8px 12px;border-radius:10px;color:#e6edf3;background:#0f1722;text-decoration:none}
    .layout{display:grid;grid-template-columns:1fr 260px;gap:20px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .card{border:1px solid #1f2a37;border-radius:18px;padding:22px;background:#0f1722}
    .meta{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
    .tag{border:1px solid #1f2a37;border-radius:999px;padding:4px 10px;color:#9db0c0}
    blockquote{border-left:3px solid #1f2a37;padding-left:12px;color:#9db0c0}
    pre{background:#0c131d;border:1px solid #1f2a37;padding:14px;border-radius:12px;overflow:auto}
    code{background:#0c131d;border:1px solid #1f2a37;padding:2px 6px;border-radius:6px}
    .muted{color:#9db0c0}
  </style>
</body>
</html>
