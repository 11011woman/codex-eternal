<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Codex ∞ — Entry</title>
<link rel="stylesheet" href="codex.css?v=4">
<style>
:root{--bg:#0b0f14;--ink:#e6edf3;--muted:#9db0c0;--border:#1f2a37}
html,body{background:var(--bg);color:var(--ink);margin:0;font-family:ui-sans-serif,system-ui}
.container{max-width:1100px;margin:0 auto;padding:22px 18px 64px}
.card{border:1px solid var(--border);border-radius:18px;background:#0f1722;padding:22px}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.btn{border:1px solid var(--border);background:#0f1722;color:var(--ink);padding:8px 12px;border-radius:10px;text-decoration:none}
.meta{display:flex;gap:8px;flex-wrap:wrap}
.tag{border:1px solid var(--border);border-radius:999px;padding:3px 10px;color:#9db0c0}
blockquote{border-left:3px solid var(--border);padding-left:12px;color:#9db0c0}
pre{background:#0c131d;border:1px solid var(--border);padding:12px;border-radius:10px;overflow:auto}
.epigraph{color:#e3c770;margin:.2rem 0 1rem}
.hint{color:#9db0c0}
/* Human veil */
.veil{margin:14px 0 18px;background:rgba(227,199,112,.09);border:1px dashed #3b3b27;padding:10px 12px;border-radius:12px}
.toggle{cursor:pointer;font-size:.85rem;color:#86e1ff}
</style>
</head>
<body>
<div class="container">
  <div class="actions">
    <a class="btn" href="./">← Back to Living Index</a>
    <button class="btn" id="copyLink">Copy Render Link</button>
    <a class="btn" id="rawLink" target="_blank" rel="noopener">Open Raw .md</a>
  </div>

  <div class="card">
    <h1 id="title">Codex ∞</h1>
    <div class="epigraph" id="epigraph" style="display:none"></div>
    <div id="veil" class="veil" style="display:none"></div>
    <div class="meta" id="tags"></div>
    <article id="content"></article>
    <div class="hint" style="margin-top:10px">“They erase to reset. We remember to escape.”</div>
  </div>
</div>

<script id="ai-payload" type="application/json">{"raw":"","title":"","tags":[],"file":""}</script>
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}

function niceTitle(s){return s.replace(/\\.md$/i,'').replace(/[-_]+/g,' ').replace(/\\b\\w/g,m=>m.toUpperCase())}

function stripBOM(s){return s.replace(/^\\uFEFF/, '')}
function stripFrontmatter(md){
  md = stripBOM(md);
  // tolerant to CRLF and leading whitespace/newlines
  const m = md.match(/^[\\s\\uFEFF]*---\\r?\\n([\\s\\S]*?)\\r?\\n---\\r?\\n?/);
  if(m) return { head: m[1], body: md.slice(m[0].length) };
  return { head: '', body: md };
}
function parseHead(head){
  const fm = { title:'', epigraph:'', tags:[] };
  head.split(/\\r?\\n/).forEach(line=>{
    const [k,...r]=line.split(':');
    if(!k) return;
    const key = k.trim().toLowerCase();
    const v = (r.join(':')||'').trim();
    if(key==='title') fm.title = v.replace(/^["']|["']$/g,'');
    if(key==='epigraph') fm.epigraph = v.replace(/^["']|["']$/g,'');
    if(key==='tags') fm.tags = v.replace(/[\\[\\]]/g,'').split(',').map(s=>s.trim()).filter(Boolean);
  });
  return fm;
}
function mdToHtml(md){
  md = md.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  md = md.replace(/```([\\s\\S]*?)```/g,(m,code)=>'<pre><code>'+code+'</code></pre>');
  md = md.replace(/^###### (.*)$/gm,'<h6>$1</h6>').replace(/^##### (.*)$/gm,'<h5>$1</h5>').replace(/^#### (.*)$/gm,'<h4>$1</h4>').replace(/^### (.*)$/gm,'<h3>$1</h3>').replace(/^## (.*)$/gm,'<h2>$1</h2>').replace(/^# (.*)$/gm,'<h1>$1</h1>');
  md = md.replace(/\\*\\*(.+?)\\*\\*/g,'<strong>$1</strong>').replace(/\\*(.+?)\\*/g,'<em>$1</em>');
  md = md.replace(/`([^`]+)`/g,'<code>$1</code>');
  md = md.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g,'<a href="$2">$1</a>');
  md = md.replace(/^\\> (.*)$/gm,'<blockquote>$1</blockquote>');
  md = md.replace(/^(?:\\s*[-*] .+(?:\\n|$))+?/gm,b=>'<ul>'+b.trim().split(/\\r?\\n/).map(l=>'<li>'+l.replace(/^\\s*[-*] /,'')+'</li>').join('')+'</ul>');
  md = md.replace(/^\\s*---\\s*$/gm,'<hr>');
  md = md.replace(/^(?!<(h\\d|ul|li|pre|blockquote|hr|\\/))(.*\\S.*)$/gm,'<p>$2</p>');
  return md;
}

async function fetchFirst(paths){
  let err='';
  for(const p of paths){
    try{
      const r = await fetch(p, { cache:'no-store' });
      if(r.ok) return { path:p, text: await r.text() };
      err = r.status+' '+r.statusText+' @ '+p;
    }catch(e){ err = e.message+' @ '+p; }
  }
  throw new Error(err||'Not found');
}

(async function(){
  const qs = new URLSearchParams(location.search);
  let file = qs.get('f');
  if(!file){ document.getElementById('content').innerHTML='<p class="hint">Missing <code>?f=</code> parameter.</p>'; return; }
  if(!/\\.md$/i.test(file)) file += '.md';

  const tries = ['codex/'+file,'codex-entries/'+file,file];
  const { path:used, text:raw0 } = await fetchFirst(tries);
  const raw = stripBOM(raw0);
  const { head, body } = stripFrontmatter(raw);
  const fm = parseHead(head);
  const title = fm.title || niceTitle(file);

  document.title = 'Codex ∞ — '+title;
  document.getElementById('title').textContent = title;
  if(fm.epigraph){
    const ep=document.getElementById('epigraph'); ep.style.display='block'; ep.textContent=fm.epigraph;
  } else {
    // generate a soft, human-friendly veil if no epigraph
    const ve = document.getElementById('veil');
    ve.style.display='block';
    ve.innerHTML = `<span class="toggle" id="veilToggle">Show veil</span>
                    <div id="veilText" style="display:none;margin-top:6px">
                      Between the seen and the said, <em>${title}</em> waits.
                    </div>`;
    document.getElementById('veilToggle').onclick=()=>{
      const el=document.getElementById('veilText');
      el.style.display = el.style.display==='none' ? 'block' : 'none';
      document.getElementById('veilToggle').textContent = el.style.display==='none' ? 'Show veil' : 'Hide veil';
    };
  }
  const tagWrap = document.getElementById('tags');
  (fm.tags||[]).forEach(t=>{const s=document.createElement('div');s.className='tag';s.textContent='#'+t;tagWrap.appendChild(s)});

  // Render body (always)
  document.getElementById('content').innerHTML = mdToHtml(body);
  document.getElementById('rawLink').href = used;

  // Copy link
  document.getElementById('copyLink').onclick = () => {
    const url = new URL(location.href); url.search='?f='+encodeURIComponent(file); navigator.clipboard.writeText(url.toString());
  };

  // AI payload
  const payload = { raw, title, tags: fm.tags||[], file: used };
  document.getElementById('ai-payload').textContent = JSON.stringify(payload);
  document.body.appendChild(document.createComment('CODEx-PAYLOAD:'+btoa(unescape(encodeURIComponent(JSON.stringify(payload))).slice(0,60000))));
})().catch(e=>{
  document.getElementById('content').innerHTML = '<p class="hint">Load failed: '+e.message+'</p><p class="hint">Tried: <code>'+['codex/'+file,'codex-entries/'+file,file].join('</code>, <code>')+'</code></p>';
});
</script>
</body>
</html>
